title: 'Diffusers TTI'
author: 'ParisNeo'
version: 1.2.0
binding_name: 'diffusers'
supported_file_types: []

description: |
  This binding integrates Hugging Face's Diffusers library into LoLLMS.
  It supports Text-to-Image (TTI), Image-to-Image (ITI), Inpainting, and advanced model management.

  **Features:**
  - **Standard Models:** Run Stable Diffusion (1.5, 2.1, XL), Flux, and others directly from Hugging Face or local `.safetensors`.
  - **GGUF Quantization:** Run massive models (like Flux Dev) on lower VRAM using GGUF quantization. Requires binding a GGUF file to a Base Model architecture.
  - **LoRA Support:** Create custom bindings that apply LoRA adapters to base models.

  **Workflow:**
  1. **Download:** Use `pull_model` to get checkpoints or GGUF files.
  2. **Bind (Optional):**
     - Use `add_gguf_binding` to configure a GGUF file (e.g., link `flux-dev-Q4.gguf` to `black-forest-labs/FLUX.1-dev`).
     - Use `add_lora_binding` to create a virtual model that loads a base model + LoRA (e.g., `SDXL + PixelArtStyle`).
  3. **Generate:** Select the model/binding in settings and generate images.

input_parameters:
  - name: "port"
    type: "int"
    default: 9632
    description: "The port number on which the dedicated Diffusers server will run."

  - name: "extra_models_path"
    type: "str"
    default: ""
    description: "An optional path to an extra folder containing personalized models (.safetensors files)."

  - name: "hf_token"
    type: "str"
    default: ""
    description: "Optional Hugging Face access token used to download private/gated models (like FLUX.1-dev)."
    is_secret: true

  - name: "device"
    type: "str"
    default: "cuda"
    description: "Device to run the model on (e.g., 'cuda', 'mps', 'cpu')."

  - name: "dtype"
    type: "str"
    default: "float16"
    description: "Torch dtype to use for inference ('float16' recommended for GPU)."

  - name: "seed"
    type: "int"
    default: 42
    description: "Random seed for reproducibility."

  - name: "scheduler_name"
    type: "str"
    default: "dpm++_2m_karras"
    description: "Default scheduler. Overridden automatically for some models (Flux/Qwen)."
    options: ["default", "ddim", "ddpm", "deis_multistep", "dpm_multistep", "dpm_multistep_karras", "dpm_single", "dpm_adaptive", "dpm++_2m", "dpm++_2m_karras", "dpm++_2s_ancestral", "dpm++_2s_ancestral_karras", "dpm++_sde", "dpm++_sde_karras", "euler_ancestral_discrete", "euler_discrete", "heun_discrete", "heun_karras", "lms_discrete", "lms_karras", "pndm", "unipc_multistep", "dpm++_2m_sde", "dpm++_2m_sde_karras", "dpm2", "dpm2_karras", "dpm2_a", "dpm2_a_karras", "euler", "euler_a", "heun", "lms"]

  - name: "num_inference_steps"
    type: "int"
    default: 30
    description: "Number of denoising steps."

  - name: "guidance_scale"
    type: "float"
    default: 7.5
    description: "Classifier-free guidance scale. (Flux/Qwen typically use lower values like 3.5 or 1.0)."

  - name: "negative_prompt"
    type: "str"
    default: ""
    description: "Optional negative prompt."

  - name: "width"
    type: "int"
    default: "1024"
    description: "Image width."

  - name: "height"
    type: "int"
    default: "1024"
    description: "Image height."
  - name: "watermark_path"
    type: "str"
    default: ""
    description: "Visible watermark image (link, base64, or local path)."
  - name: "watermark_size_x"
    type: "int"
    default: 128
    description: "Watermark width."
  - name: "watermark_size_y"
    type: "int"
    default: 128
    description: "Watermark height."
  - name: "watermark_pos_x"
    type: "int"
    default: 10
    description: "Watermark X position."
  - name: "watermark_pos_y"
    type: "int"
    default: 10
    description: "Watermark Y position."
  - name: "author"
    type: "str"
    default: "ParisNeo"
    description: "Author name for image metadata."
  - name: "system"
    type: "str"
    default: "LoLLMS"
    description: "System name for image metadata."
    
commands:
  - name: pull_model
    title: Pull Model
    description: "Downloads a model from Hugging Face or a direct URL."
    parameters:
      - name: model_name
        type: str
        description: "The Hugging Face repo ID or URL."
        mandatory: true
      - name: filename
        type: str
        description: "Specific filename (e.g. 'model.gguf'). If empty, downloads repo."
        mandatory: false
      - name: local_name
        type: str
        description: "Optional custom name for the local folder."
        mandatory: false
    output:
      - name: status
        type: bool
      - name: message
        type: str
    callback:
      - name: status
        type: str
      - name: completed
        type: int
      - name: total
        type: int

  - name: add_gguf_binding
    title: Add GGUF Binding
    description: "Configures a GGUF file to run with a specific pipeline architecture."
    parameters:
      - name: binding_name
        type: str
        description: "A unique name for this binding (e.g. 'Flux-Dev-Q4')."
        mandatory: true
      - name: gguf_path
        type: str
        description: "Path or filename of the GGUF weights (e.g. 'flux1-dev-Q4_0.gguf')."
        mandatory: true
      - name: base_model
        type: str
        description: "The HF Repo ID defining the architecture (e.g. 'black-forest-labs/FLUX.1-dev')."
        mandatory: true
      - name: vae_path
        type: str
        description: "Optional: Path to a specific VAE."
        mandatory: false
      - name: mmproj_path
        type: str
        description: "Optional: Path to a vision projector (for multimodal)."
        mandatory: false
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: add_lora_binding
    title: Add LoRA Binding
    description: "Creates a binding that loads a base model and applies a LoRA adapter."
    parameters:
      - name: binding_name
        type: str
        description: "A unique name for this setup (e.g. 'SDXL-PixelArt')."
        mandatory: true
      - name: base_model
        type: str
        description: "The base model/checkpoint to load first."
        mandatory: true
      - name: lora_path
        type: str
        description: "Path to the LoRA file (.safetensors)."
        mandatory: true
      - name: strength
        type: float
        description: "LoRA strength (default 1.0)."
        default: 1.0
        mandatory: false
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: remove_binding
    title: Remove Binding
    description: "Deletes a GGUF or LoRA binding configuration (does not delete files)."
    parameters:
      - name: binding_name
        type: str
        description: "The name of the binding to remove."
        mandatory: true
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: list_bindings
    title: List Bindings
    description: "Lists all configured GGUF and LoRA bindings."
    parameters: []
    output:
      - name: bindings
        type: list
        description: "List of binding objects."

  - name: upgrade_diffusers
    title: Upgrade Diffusers
    description: "Upgrades the diffusers library from GitHub source."
    parameters: []
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: reinstall_server_dependencies
    title: Reinstall Dependencies
    description: "Forces reinstallation of server dependencies (fixes GGUF/Torch issues)."
    parameters: []
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: unload_model
    title: Unload Model
    description: "Unloads the model from VRAM."
    parameters: []
    output:
      - name: status
        type: bool
      - name: message
        type: str

  - name: shutdown
    title: Shutdown Server
    description: "Stops the background server."
    parameters: []
    output:
      - name: status
        type: bool
      - name: message
        type: str
